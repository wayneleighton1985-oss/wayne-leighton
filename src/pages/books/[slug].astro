---
import MainLayout from '../../layouts/MainLayout.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const books = await getCollection('books');
  return books.map((book: CollectionEntry<'books'>) => ({
    params: { slug: book.slug },
    props: { book },
  }));
}

const { book } = Astro.props as { book: CollectionEntry<'books'> };
const { Content } = await book.render();

// Structured data for SEO
const structuredData = {
  "@context": "https://schema.org",
  "@type": "Book",
  "name": book.data.title,
  "author": {
    "@type": "Person",
    "name": book.data.author
  },
  "description": book.data.description,
  "image": book.data.coverImageUrl,
  "isbn": book.data.isbn,
  "numberOfPages": book.data.pages,
  "datePublished": book.data.publishedYear.toString(),
  "publisher": {
    "@type": "Organization",
    "name": "Wayne Leighton Books"
  },
  "offers": {
    "@type": "Offer",
    "price": book.data.price,
    "priceCurrency": "GBP",
    "availability": "https://schema.org/InStock",
    "itemCondition": "https://schema.org/NewCondition"
  }
};
---

<MainLayout 
  title={`${book.data.title} by ${book.data.author} - Wayne Leighton Books`}
  description={book.data.description}
  image={book.data.coverImageUrl}
>
  <!-- Structured Data -->
  <script type="application/ld+json" is:inline set:html={JSON.stringify(structuredData)}></script>
  
  <!-- Preload cover image -->
  <link rel="preload" as="image" href={book.data.coverImageUrl} />

  <section class="py-12">
    <div class="container mx-auto px-4">
      <!-- Breadcrumb -->
      <nav class="mb-8">
        <ol class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
          <li><a href="/" class="hover:text-primary-600 dark:hover:text-primary-400">Home</a></li>
          <li><span class="mx-2">/</span></li>
          <li><a href="/shop" class="hover:text-primary-600 dark:hover:text-primary-400">Shop</a></li>
          <li><span class="mx-2">/</span></li>
          <li class="text-gray-900 dark:text-white">{book.data.title}</li>
        </ol>
      </nav>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
        <!-- Book Cover -->
        <div class="space-y-4">
          <div class="aspect-[3/4] bg-gray-100 dark:bg-gray-800 rounded-lg overflow-hidden">
            <img 
              src={book.data.coverImageUrl} 
              alt={`${book.data.title} cover`}
              class="w-full h-full object-cover"
            />
          </div>
          
          <!-- Additional Info -->
          <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
            <h3 class="font-semibold text-gray-900 dark:text-white mb-2">Book Details</h3>
            <div class="space-y-1 text-sm text-gray-600 dark:text-gray-400">
              <div class="flex justify-between">
                <span>Format:</span>
                <span class="text-gray-900 dark:text-white">{book.data.format}</span>
              </div>
              <div class="flex justify-between">
                <span>Category:</span>
                <span class="text-gray-900 dark:text-white">{book.data.category}</span>
              </div>
              <div class="flex justify-between">
                <span>Published:</span>
                <span class="text-gray-900 dark:text-white">{book.data.publishedYear}</span>
              </div>
              {book.data.pages && (
                <div class="flex justify-between">
                  <span>Pages:</span>
                  <span class="text-gray-900 dark:text-white">{book.data.pages}</span>
                </div>
              )}
              {book.data.isbn && (
                <div class="flex justify-between">
                  <span>ISBN:</span>
                  <span class="text-gray-900 dark:text-white">{book.data.isbn}</span>
                </div>
              )}
            </div>
          </div>
        </div>

        <!-- Book Info & Purchase -->
        <div class="space-y-6">
          <div>
            <div class="mb-2">
              <span class="inline-block bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-200 text-sm px-3 py-1 rounded-full">
                {book.data.category}
              </span>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-2">
              {book.data.title}
            </h1>
            <p class="text-xl text-gray-600 dark:text-gray-300 mb-4">
              by {book.data.author}
            </p>
          </div>

          <!-- Description -->
          <div>
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">About This Book</h2>
            <div class="prose prose-gray dark:prose-invert max-w-none">
              <Content />
            </div>
          </div>

          <!-- Purchase Section -->
          <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{book.data.format}</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  {book.data.format === 'eBook' ? 'Instant download • PDF & EPUB formats' : 
                   book.data.format === 'Hard copy' ? 'Physical book • Free shipping on orders over £25' :
                   book.data.format === 'Transcripts Edition' ? 'Printed transcripts • Includes digital access' :
                   'Seminar access • Includes digital materials'}
                </p>
              </div>
              <div class="text-2xl font-bold text-primary-600 dark:text-primary-400">
                £{book.data.price}
              </div>
            </div>

            <!-- Purchase Button -->
            <button 
              class="snipcart-add-item w-full bg-primary-600 hover:bg-primary-700 text-white px-6 py-4 rounded-lg font-semibold text-lg transition-colors flex items-center justify-center space-x-2"
              data-item-id={book.slug}
              data-item-price={book.data.price}
              data-item-url={`https://findyourpassion.co.uk/books/${book.slug}`}
              data-item-image={book.data.coverImageUrl.startsWith('http') ? book.data.coverImageUrl : `https://findyourpassion.co.uk${book.data.coverImageUrl}`}
              data-item-name={`${book.data.title} (${book.data.format})`}
              data-item-description={book.data.description}
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.5 6M7 13l-1.5-6m0 0h15M17 21a2 2 0 100-4 2 2 0 000 4zM9 21a2 2 0 100-4 2 2 0 000 4z"></path>
              </svg>
              <span>Add to Cart - £{book.data.price}</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>
</MainLayout>